name: Test LLM APIs

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'LLM Provider to test'
        required: true
        type: choice
        options:
          - gemini
          - deepseek
          - both

jobs:
  test-llm-integration:
    runs-on: ubuntu-latest
    environment: test
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local with API keys
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env.local
          echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" >> .env.local
          echo "DEEPSEEK_MODEL_NAME=${{ vars.DEEPSEEK_MODEL_NAME || 'deepseek/deepseek-chat-v3-0324:free' }}" >> .env.local

      - name: Create test script
        run: |
          cat > test-llm.mjs << 'EOF'
          import { formalizeProblem, generateProof, explainProof } from './services/llmService.ts';
          
          const testProblem = "Ð¡Ð¾ÐºÑ€Ð°Ñ‚ â€” Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº. Ð’ÑÐµ Ð»ÑŽÐ´Ð¸ ÑÐ¼ÐµÑ€Ñ‚Ð½Ñ‹. Ð”Ð¾ÐºÐ°Ð¶Ð¸, Ñ‡Ñ‚Ð¾ Ð¡Ð¾ÐºÑ€Ð°Ñ‚ ÑÐ¼ÐµÑ€Ñ‚ÐµÐ½.";
          const provider = process.argv[2] || 'gemini';
          
          console.log(`\nðŸ§ª Testing ${provider.toUpperCase()} API...\n`);
          console.log('Problem:', testProblem);
          
          try {
            console.log('\nðŸ“ Step 1: Formalization...');
            const formalization = await formalizeProblem(testProblem, provider);
            console.log('Result:', formalization);
            
            console.log('\nâš™ï¸  Step 2: Proof Generation...');
            const proof = await generateProof(formalization, provider);
            console.log('Result:', proof);
            
            console.log('\nðŸ’¬ Step 3: Explanation...');
            const explanation = await explainProof(proof, provider);
            console.log('Result:', explanation);
            
            console.log(`\nâœ… ${provider.toUpperCase()} API test completed successfully!`);
            process.exit(0);
          } catch (error) {
            console.error(`\nâŒ ${provider.toUpperCase()} API test failed:`, error.message);
            process.exit(1);
          }
          EOF

      - name: Build project
        run: npm run build

      - name: Test Gemini API
        if: ${{ github.event.inputs.provider == 'gemini' || github.event.inputs.provider == 'both' }}
        env:
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: npx tsx test-llm.mjs gemini

      - name: Test Deepseek API
        if: ${{ github.event.inputs.provider == 'deepseek' || github.event.inputs.provider == 'both' }}
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_MODEL_NAME: ${{ vars.DEEPSEEK_MODEL_NAME || 'deepseek/deepseek-chat-v3-0324:free' }}
        run: npx tsx test-llm.mjs deepseek

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Provider tested: ${{ github.event.inputs.provider }}" >> $GITHUB_STEP_SUMMARY
          echo "Build status: âœ…" >> $GITHUB_STEP_SUMMARY
